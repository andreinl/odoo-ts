<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

<!-- cfr. account_report.xml -->

<!-- ho tolto file="l10n_it_export_ts.qweb_invoice_xml_ts"
            -->
        <report 
            id="report_invoice_xml_ts"
            model="account.invoice"
            string="Fatture XML TS"
            report_type="qweb-html"
            name="l10n_it_export_ts.qweb_invoice_xml_ts"
            attachment_use="True"
            attachment="(object.state in ('open','paid')) and ('FAT'+(object.number or '').replace('/','')+'.html')"
        />

<template id="qweb_invoice_xml_ts">
<t r-raw="'&gt;?xml version=1.0?>'" />
<t t-name="l10n_it_export_ts.qweb_invoice_xml_ts">
<precompilata>
    <!-- Multicompany -->
<!-- dalla v.11 qui trovo: docs e doc_ids, non o -->
    <t t-call="l10n_it_export_ts.header_xml_ts"/>
    <t t-foreach="docs" t-as="o">
        <!--t t-raw="translate_doc(doc_id, doc_model, 'partner_id.lang', 'l10n_it_export_ts.report_invoice_document_xml_ts')"/-->
        <t t-call="l10n_it_export_ts.report_invoice_document_xml_ts"/>
    </t>
</precompilata>
</t>
</template>

<template id="header_xml_ts">
<t t-name="l10n_it_export_ts.header_xml_ts">
  <proprietario>
  <!-- se fosse una Struttura qui il formato è differente-->
      <cfProprietario><t t-raw="res_company.partner_id.fiscalcode_enc"/></cfProprietario>
  </proprietario>
</t>
</template>

<template id="report_invoice_document_xml_ts">
<t t-name="report_invoice_document_xml_ts">
    <!-- Multicompany -->
    <t t-if="o and 'company_id' in o"><t t-set="company" t-value="o.company_id"/></t>
    <t t-if="not o or not 'company_id' in o"><t t-set="company" t-value="res_company"/></t>
<t t-if="(not o.partner_id.opposizione_730) and (not o.partner_id.is_company)" > <!--FIXME se non persona fisica è corretto escluderlo? -->
<documentoSpesa>
  <idSpesa>
       <pIva><t t-if="company.partner_id.vat"><t t-raw="company.partner_id.vat[2:]"/></t></pIva>
       <dataEmissione><t t-raw="o.date_invoice"/></dataEmissione>
       <numDocumentoFiscale>
          <!--registratore di cassa. 1 = fattura -->
          <dispositivo><t t-raw="1"/></dispositivo>
          <numDocumento><t t-raw="o.number"/></numDocumento>
       </numDocumentoFiscale>
  </idSpesa>
  <!-- regime dei minimi: data pagamento=data fattura -->
  <dataPagamento><t t-raw="o.date_invoice"/></dataPagamento>
  <!-- I=inserimento. Ci sono anche rimborso e variazione. -->
  <flagOperazione><t t-raw="'I'"/></flagOperazione>
  <!-- da crittografare -->
  <cfCittadino><t t-raw="o.partner_id.fiscalcode_enc"/></cfCittadino>
  <!-- in teoria, ce ne vorrebbe uno diverso per ogni riga di fattura. Faccio il totale. -->
  <voceSpesa>
      <!-- tipologia di spesa. SP=Prestazioni Sanitarie -->
      <tipoSpesa><t t-raw="'SP'"/></tipoSpesa>
      <importo><t t-raw="'%.2f' % o.amount_total"/></importo>
  </voceSpesa>
NUOVA VERSIONE
  <t t-foreach="o.invoice_line_ids" t-as="o">
        <t t-call="l10n_it_export_ts.report_invoice_riga_xml_ts"/>
  </t>
</documentoSpesa>
</t>

</t>
</template>

<template id="report_invoice_riga_xml_ts">

<!-- TODO fare un ciclo for sulle righe
da chiarire fiscalmente cosa succede quando ci sono più righe di spesa diverse e ad es. la marca da bollo... -->
  <voceSpesa>
      <!-- tipologia di spesa. SP=Prestazioni Sanitarie -->
      <tipoSpesa><t t-raw="o.product_id.tipo_spesa_730"/></tipoSpesa>
      <importo><t t-raw="o.amount"/></importo>
  </voceSpesa>
</template>

    </data>
</openerp>
